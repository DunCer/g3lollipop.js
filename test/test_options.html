<!DOCTYPE html>
<html>

<head>
  <link rel="shortcut icon" href="../favicon.ico">
  <link rel="stylesheet" media="screen" href="../css/style.min.css" />
  <style>
    .warp {
      margin-left: 40px;
    }

    #svg-panel {
      border: 2px solid black;
    }

    .console {
      display: block;
      width: 900px;
      height: 80px;
      margin: 10px 0px;
      background-color: rgb(233, 233, 233);
      color: rgb(12, 12, 12);
      overflow-y: scroll;
      padding: 10px;
      font: normal 12px Arial;
    }

    div.prev {
      color: blue;
      padding-left: 20px;
    }

    div.cur {
      color: firebrick;
      padding-left: 20px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="ctrl-panel">
      <span class="btn-group">
        <button id="save-as-png">Save PNG</button>
        <button id="save-as-svg">Save SVG</button>
        <button id="next">Start</button>
      </span>
    </div>

    <div class="console" id="info">
    </div>

    <div id="plot-panel">
      <svg id="svg-panel">
      </svg>
    </div>
  </div>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="../dist/g3-lollipop.js"></script>
  <script>
    var snvFile = "../data/snv/TP53-msk_impact_2017-parsed.tsv";
    var domainFile = "../data/domain/TP53_pfam.json";

    var snvOpt = {
      x: "AA_Position",
      y: "Protein_Change",
      factor: "Mutation_Class",
    };

    var domainOpt = {
      symbol: "hgnc_symbol",
      name: "protein_name",
      length: "length",
      domainType: "pfam",
      details: {
        start: "pfam_start",
        end: "pfam_end",
        ac: "pfam_ac",
        name: "pfam_id",
      },
    };

    var setting_list = [{
        lollipopTrackHeight: 230,
        lollipopTrackBackground: "wheat",
        lollipopPopMinSize: 3,
        lollipopPopMaxSize: 6,
        lollipopPopInfoLimit: 5,
      },
      {
        lollipopPopMinSize: 1,
        lollipopPopMaxSize: 3,
        lollipopPopInfoLimit: 2,
        mainHeight: 200,
        width: 400
      },
      {
        lollipopLabelRatio: 2,
        lollipopLabelMinFontSize: 10,
      },
      {
        margin: {
          top: 30,
          left: 40,
          right: 10,
          bottom: 20
        },
        titleText: "TP53 mutation profile",
        titleFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        titleColor: "firebrick",
        titleAlignment: "start",
      },
      {
        margin: {
          top: 30,
          left: 40,
          right: 10,
          bottom: 20
        },
        titleText: "TP53 mutation profile",
        titleFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        titleColor: "firebrick",
        titleAlignment: "middle",
      },
      {
        margin: {
          top: 30,
          left: 40,
          right: 10,
          bottom: 20
        },
        titleText: "TP53 mutation profile",
        titleFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        titleColor: "firebrick",
        titleAlignment: "end",
      },
      {
        axisLabelFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        axisLabelColor: "steelblue",
        axisLabelAlignment: "start",
      },
      {
        axisLabelFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        axisLabelColor: "steelblue",
        axisLabelAlignment: "middle",
      },
      {
        axisLabelFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        axisLabelColor: "steelblue",
        axisLabelAlignment: "end",
      },
      {
        annoHeight: 60,
        annoMargin: {
          top: 5,
          bottom: 30,
        },
        annoBackground: "grey",
        annoBarFill: "wheat",
        annoBarMargin: {
          top: 4,
          bottom: 4,
        },
      },
      {
        domainMargin: {
          top: -8,
          bottom: -8,
        },
        domainTextFont: "italic small-caps normal 13px/150% Arial, Helvetica, sans-serif",
        domainTextColor: "firebrick",
      },
      {
        brush: false,
      },
      {
        zoom: false,
      },
      {
        brush: false,
        zoom: false,
      },
    ];

    var idx = 0;
    var len_settings = setting_list.length;
    var lollipop, cur_setting, prev_setting, info;
    var next_btn = document.getElementById("next");
    var info_box = document.getElementById("info");

    var _print = function (str) {
      return (typeof str === "object") ? JSON.stringify(str) : str;
    }

    var q = d3.queue();
    q.defer(d3.tsv, snvFile);
    q.defer(d3.json, domainFile);

    q.await(function (error, snvData, domainData) {
      snvData.forEach(function (d) {
        d[snvOpt.x] = +d[snvOpt.x];
      });

      lollipop = g3.Lollipop("svg", "pie", 800);
      lollipop.data.snvData = snvData;
      lollipop.data.domainData = domainData;

      next_btn.onclick = function (e) {
        if (idx == 0) {
          next_btn.innerHTML = "Next";
        }

        if (idx < len_settings) {
          // reset options
          if (idx != 0) {
            lollipop.setOptions(prev_setting);
          }

          cur_setting = setting_list[idx];
          prev_setting = lollipop.getOptions(Object.keys(cur_setting));
          lollipop.setOptions(cur_setting);

          info = "Test " + (idx + 1) + "<br> <div class=\"prev\">" +
            _print(prev_setting) + "</div><div class=\"cur\">" +
            _print(cur_setting) + "</div>";
          info_box.innerHTML += info;
          info_box.scrollTop = info_box.scrollHeight;

          lollipop.refresh();

          idx++;
          if (idx == len_settings) {
            next_btn.innerHTML = "Done";
            next_btn.disabled = true;
          }
        }
      };

      document.getElementById("save-as-png").onclick = function (e) {
        g3.output("svg").toPNG('out_png');
      };

      document.getElementById("save-as-svg").onclick = function (e) {
        g3.output('svg').toSVG('out_svg');
      };
    });
  </script>
</body>

</html>